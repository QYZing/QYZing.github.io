<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/earth.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/earth.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.dying.asia","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"manual","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="【计算机网络】cs144 lab为了更好的贯彻手拿TCP脚踩UDP兜里装个ICMP的意愿，遂写一个小lab 由于再写时官网还没有更新完文档于是用了一个大佬搭的备份19年版本【计算机网络】Stanford CS144 Lab Assignments 学习笔记 - 康宇PL - 博客园 (cnblogs.com) 我的gitee链接:cs144 lab: cs144 lab 目前正在一个 一个打补丁往">
<meta property="og:type" content="article">
<meta property="og:title" content="cs144 lab0 - lab4">
<meta property="og:url" content="https://www.dying.asia/2023/05/15/cs144-lab/index.html">
<meta property="og:site_name" content="dying Blog">
<meta property="og:description" content="【计算机网络】cs144 lab为了更好的贯彻手拿TCP脚踩UDP兜里装个ICMP的意愿，遂写一个小lab 由于再写时官网还没有更新完文档于是用了一个大佬搭的备份19年版本【计算机网络】Stanford CS144 Lab Assignments 学习笔记 - 康宇PL - 博客园 (cnblogs.com) 我的gitee链接:cs144 lab: cs144 lab 目前正在一个 一个打补丁往">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.dying.asia/images/assets/1683900423271.png">
<meta property="og:image" content="https://www.dying.asia/images/assets/1683900625517.png">
<meta property="og:image" content="https://www.dying.asia/images/assets/1683896785929.png">
<meta property="og:image" content="https://www.dying.asia/images/assets/1683896910636.png">
<meta property="og:image" content="https://www.dying.asia/images/assets/1684159752455.png">
<meta property="article:published_time" content="2023-05-15T15:22:00.000Z">
<meta property="article:modified_time" content="2023-05-15T14:20:27.095Z">
<meta property="article:author" content="dying">
<meta property="article:tag" content="cs144lab">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.dying.asia/images/assets/1683900423271.png">

<link rel="canonical" href="https://www.dying.asia/2023/05/15/cs144-lab/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>cs144 lab0 - lab4 | dying Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">dying Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="download fa-fw"></i>资源</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-guestbook">

    <a href="/guestbook/" rel="section"><i class="fa fa-book fa-fw"></i>留言</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.dying.asia/2023/05/15/cs144-lab/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.jpg">
      <meta itemprop="name" content="dying">
      <meta itemprop="description" content="想都是问题，做才是答案">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dying Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          cs144 lab0 - lab4
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-05-15 23:22:00 / 修改时间：22:20:27" itemprop="dateCreated datePublished" datetime="2023-05-15T23:22:00+08:00">2023-05-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cs-lab/" itemprop="url" rel="index"><span itemprop="name">cs-lab</span></a>
                </span>
            </span>

          
            <span id="/2023/05/15/cs144-lab/" class="post-meta-item leancloud_visitors" data-flag-title="cs144 lab0 - lab4" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2023/05/15/cs144-lab/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2023/05/15/cs144-lab/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="【计算机网络】cs144-lab"><a href="#【计算机网络】cs144-lab" class="headerlink" title="【计算机网络】cs144 lab"></a>【计算机网络】cs144 lab</h1><p><strong>为了更好的贯彻手拿TCP脚踩UDP兜里装个ICMP的意愿，遂写一个小lab</strong></p>
<p>由于再写时官网还没有更新完文档于是用了一个大佬搭的备份19年版本<a target="_blank" rel="noopener" href="https://www.cnblogs.com/kangyupl/p/stanford_cs144_labs.html">【计算机网络】Stanford CS144 Lab Assignments 学习笔记 - 康宇PL - 博客园 (cnblogs.com)</a></p>
<p>我的gitee链接:<a target="_blank" rel="noopener" href="https://gitee.com/dying1122/cs144-lab#%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95%E4%B8%8Ebug">cs144 lab: cs144 lab 目前正在一个 一个打补丁往后写 (gitee.com)</a></p>
<p>我是在看完中科大的网络就直接写这个了，搭配【 计算机网络自顶向下 &amp;&amp; TCP/IP 详解 卷1】</p>
<p>前言：</p>
<p>本lab实验环境在centos g++ 8 实现 cmake版本12</p>
<p>如果make 报错在tun.cc  可在里面添加头文件</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tun.hh&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;util.hh&quot;</span></span></span><br><span class="line"><span class="comment">//下面这俩个</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>需要调试可看lab4里的调试技巧</p>
<span id="more"></span>

<h2 id="LAB0"><a href="#LAB0" class="headerlink" title="LAB0"></a>LAB0</h2><h6 id="Writing-webget"><a href="#Writing-webget" class="headerlink" title="Writing webget"></a>Writing webget</h6><p>利用提供的API写个GET请求就可以</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">get_URL</span><span class="params">(<span class="type">const</span> string &amp;host, <span class="type">const</span> string &amp;path)</span> </span>&#123;</span><br><span class="line">    std::unique_ptr&lt;TCPSocket&gt; sock = std::<span class="built_in">make_unique</span>&lt;TCPSocket&gt;();</span><br><span class="line">    sock-&gt;<span class="built_in">connect</span>(<span class="built_in">Address</span>(host,<span class="string">&quot;http&quot;</span>));</span><br><span class="line">    std::string mesage  = <span class="string">&quot;GET &quot;</span> + path + <span class="string">&quot; HTTP/1.1\r\n&quot;</span></span><br><span class="line">                        +<span class="string">&quot;Host: &quot;</span> + host + <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">                        +<span class="string">&quot;Connection: close \r\n\r\n&quot;</span>;</span><br><span class="line">    sock-&gt;<span class="built_in">write</span>(mesage);</span><br><span class="line">    sock-&gt;<span class="built_in">shutdown</span>(SHUT_WR);</span><br><span class="line">    <span class="keyword">while</span>(!sock-&gt;<span class="built_in">eof</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        cout&lt;&lt;sock-&gt;<span class="built_in">read</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    cerr &lt;&lt; <span class="string">&quot;Function called: get_URL(&quot;</span> &lt;&lt; host &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; path &lt;&lt; <span class="string">&quot;).\n&quot;</span>;</span><br><span class="line">    cerr &lt;&lt; <span class="string">&quot;Warning: get_URL() has not been implemented yet.\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ps  如果出现 t_webget (Failed)错误 修改tests/webget_t.sh 权限 +x</span></span><br></pre></td></tr></table></figure>

<h6 id="An-in-memory-reliable-byte-stream"><a href="#An-in-memory-reliable-byte-stream" class="headerlink" title="An in-memory reliable byte stream"></a>An in-memory reliable byte stream</h6><p>要求实现一个有序字节流类（in-order byte stream），使之支持读写、容量控制。这个字节流类似于一个带容量的队列，从一头读，从另一头写。当流中的数据达到容量上限时，便无法再写入新的数据。特别的，写操作被分为了peek和pop两步。peek为从头部开始读取指定数量的字节，pop为弹出指定数量的字节。英语不好一开始还真看不太懂eof是干嘛用的</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//.hh	</span></span><br><span class="line">	<span class="type">size_t</span> _capacity; </span><br><span class="line">    std::deque&lt;<span class="type">char</span>&gt; _data &#123;&#125;;</span><br><span class="line">    <span class="type">size_t</span> _bytes_Wrlen = <span class="number">0</span> ;</span><br><span class="line">    <span class="type">size_t</span> _bytes_Poplen = <span class="number">0</span>;</span><br><span class="line">    <span class="type">bool</span> _input_signal = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">bool</span> _error = <span class="literal">false</span>;  <span class="comment">//!&lt; Flag indicating that the stream suffered an error.</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//.cc</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;byte_stream.hh&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iterator&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Dummy implementation of a flow-controlled in-memory byte stream.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// For Lab 0, please replace with a real implementation that passes the</span></span><br><span class="line"><span class="comment">// automated checks run by `make check_lab0`.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// You will need to add private members to the class declaration in `byte_stream.hh`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span>... Targs&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DUMMY_CODE</span><span class="params">(Targs &amp;&amp;... <span class="comment">/* unused */</span>)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line">ByteStream::<span class="built_in">ByteStream</span>(<span class="type">const</span> <span class="type">size_t</span> capacity) :</span><br><span class="line"> _capacity(capacity) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">ByteStream::write</span><span class="params">(<span class="type">const</span> string &amp;data1)</span> </span>&#123;</span><br><span class="line">    <span class="type">size_t</span> Len  = <span class="built_in">remaining_capacity</span>();</span><br><span class="line">    <span class="type">size_t</span> Add_length = Len &gt;= data1.<span class="built_in">size</span>() ? data1.<span class="built_in">size</span>() : Len;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">size_t</span> i =<span class="number">0</span> ;i &lt; Add_length ; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        _data.<span class="built_in">push_back</span>(data1[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    _bytes_Wrlen += Add_length;</span><br><span class="line">    <span class="keyword">return</span> Add_length;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//! \param[in] len bytes will be copied from the output side of the buffer</span></span><br><span class="line"><span class="function">string <span class="title">ByteStream::peek_output</span><span class="params">(<span class="type">const</span> <span class="type">size_t</span> len)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    <span class="type">size_t</span> Len = _data.<span class="built_in">size</span>();</span><br><span class="line">    <span class="type">size_t</span> Peek_Length = Len &gt; len ? len : Len;</span><br><span class="line">    <span class="keyword">return</span> &#123;_data.<span class="built_in">begin</span>() ,_data.<span class="built_in">begin</span>() + Peek_Length&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//! \param[in] len bytes will be removed from the output side of the buffer</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ByteStream::pop_output</span><span class="params">(<span class="type">const</span> <span class="type">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="type">size_t</span> Len = _data.<span class="built_in">size</span>();</span><br><span class="line">    <span class="type">size_t</span> Peek_Length = Len &gt; len ? len : Len;</span><br><span class="line">    _bytes_Poplen += Peek_Length;</span><br><span class="line">    _data.<span class="built_in">erase</span>(_data.<span class="built_in">begin</span>() , _data.<span class="built_in">begin</span>() + Peek_Length);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ByteStream::end_input</span><span class="params">()</span> </span>&#123; _input_signal = <span class="literal">true</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ByteStream::input_ended</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> _input_signal; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">ByteStream::buffer_size</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> _data.<span class="built_in">size</span>(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ByteStream::buffer_empty</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> _data.<span class="built_in">empty</span>(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ByteStream::eof</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> _input_signal &amp;&amp; <span class="built_in">buffer_empty</span>(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">ByteStream::bytes_written</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> _bytes_Wrlen; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">ByteStream::bytes_read</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> _bytes_Poplen; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">ByteStream::remaining_capacity</span><span class="params">()</span> <span class="type">const</span> </span>&#123;  <span class="keyword">return</span> _capacity - _data.<span class="built_in">size</span>(); &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="LAB1"><a href="#LAB1" class="headerlink" title="LAB1"></a>LAB1</h2><p>本实验要求实现一个流重组器（stream reassembler）， 其中可以 重复， 乱序， 碎片</p>
<p>1 如果已经成功组成一个开头到之后的流片段那么应该立即放入_output中</p>
<p>2 EOF 可能提前到，也可能只是一个EOF空串</p>
<p>3 如果字节流满了同样无法写入，除非字节流被pop出，流重组器满了也一样，后续来的碎片只能被丢弃</p>
<p>根据本题碎片有可能交叉而且重复，且有EOF限制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">根据上述分析 来的是碎片化的字节流 而且有重复， 就相当于一个一个集合，当集合有交集的时候可以合成一个大集合</span><br><span class="line">不过我打算直接用vector&lt;char&gt; 来存储 因为只有开头流是一个整体就可以存入byte_stream所以维护一个已存入流的下标就可以了，另外就是区分碎片和非碎片，我选用了vector&lt;bool&gt; 来进行辨别（vecotr&lt;bool&gt; 遍历时不用引用修改）, 碎片有交集合并这件事就很简单了，因为本身数组特性就可以去重合并，其中当开头插入一个碎片时还需判断后续碎片是否已经完整，所以记录一个下标判断到不完整即可 而且由于防止byte不能同步写入记录一个下标用于记录写入数量</span><br></pre></td></tr></table></figure>

<h6 id="stream-reassembler-hh"><a href="#stream-reassembler-hh" class="headerlink" title="stream_reassembler.hh"></a>stream_reassembler.hh</h6><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span>: </span><br><span class="line">    ByteStream _output;  <span class="comment">//!&lt; The reassembled in-order byte stream</span></span><br><span class="line">    <span class="type">size_t</span> _capacity ;      <span class="comment">//!&lt; The maximum number of bytes</span></span><br><span class="line">    <span class="comment">// Your code here -- add private members as necessary.</span></span><br><span class="line">    std::vector&lt;<span class="type">char</span>&gt; _assembles &#123;&#125; ; <span class="comment">//assembles string by index  if ok -&gt; _output</span></span><br><span class="line">    std::vector&lt;<span class="type">bool</span>&gt; _set&#123;&#125;; <span class="comment">// ture or false exist</span></span><br><span class="line">    <span class="type">size_t</span> _now_index &#123;&#125;; <span class="comment">// assembled bytes index</span></span><br><span class="line">    <span class="type">size_t</span> _now_assem_byteix &#123;&#125;; <span class="comment">//alreday write _output index</span></span><br><span class="line">    <span class="type">size_t</span> _end_index =  <span class="number">-1</span>;  <span class="comment">// eof index </span></span><br><span class="line">    <span class="type">size_t</span> _sum_bytes &#123;&#125;;</span><br><span class="line">    <span class="type">int</span> _full_flag &#123;&#125;; <span class="comment">// 当容器满了但是还eof还没到++</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">StreamReassembler::residue</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"><span class="function"><span class="type">uint64_t</span>  <span class="title">StreamReassembler::headno</span><span class="params">()</span> <span class="type">const</span> </span>;</span><br></pre></td></tr></table></figure>

<h6 id="stream-reassembler-cc"><a href="#stream-reassembler-cc" class="headerlink" title="stream_reassembler.cc"></a>stream_reassembler.cc</h6><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">StreamReassembler::<span class="built_in">StreamReassembler</span>(<span class="type">const</span> <span class="type">size_t</span> capacity) :</span><br><span class="line">                     _output(capacity), _capacity(capacity) &#123;</span><br><span class="line">    _assembles.<span class="built_in">resize</span>(_capacity);</span><br><span class="line">    _set.<span class="built_in">resize</span>(_capacity);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;i : _assembles)</span><br><span class="line">        i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> i : _set)</span><br><span class="line">        i = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//! \details This function accepts a substring (aka a segment) of bytes,</span></span><br><span class="line"><span class="comment">//! possibly out-of-order, from the logical stream, and assembles any newly</span></span><br><span class="line"><span class="comment">//! contiguous substrings and writes them into the output stream in order.</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">StreamReassembler::push_substring</span><span class="params">(<span class="type">const</span> string &amp;data, <span class="type">const</span> <span class="type">size_t</span> index, <span class="type">const</span> <span class="type">bool</span> eof)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">size_t</span> offset = _full_flag * _capacity;</span><br><span class="line">    <span class="type">size_t</span> end = data.<span class="built_in">size</span>() + index;</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">1</span> == eof) _end_index = end;</span><br><span class="line">    <span class="type">size_t</span> start = index &gt;  _now_index + offset ? index : _now_index + offset;</span><br><span class="line">    <span class="keyword">if</span>(end  - offset &gt; _capacity) end = _capacity + offset;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">size_t</span> i = start ; i &lt; end ; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">size_t</span> ci = i % (_capacity);</span><br><span class="line">        <span class="keyword">if</span>(_set[ci] == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            _set[ci] = <span class="number">1</span>;</span><br><span class="line">            _assembles[ci] = data[i - index];</span><br><span class="line">            ++_sum_bytes;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(_now_index == ci)</span><br><span class="line">        &#123;</span><br><span class="line">            _now_index =end  - offset ;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(_now_index &lt; _capacity &amp;&amp;  <span class="number">1</span> == _set[_now_index])</span><br><span class="line">    &#123;</span><br><span class="line">        _now_index++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(_now_assem_byteix &lt; _now_index)<span class="comment">//have possible bug</span></span><br><span class="line">    &#123;</span><br><span class="line">        string datatmp;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">size_t</span> i = _now_assem_byteix ; i &lt; _now_index ; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            datatmp += _assembles[i];</span><br><span class="line">            _set[i] = <span class="number">0</span>;</span><br><span class="line">        &#125; </span><br><span class="line">	    <span class="type">size_t</span> size = _output.<span class="built_in">write</span>(datatmp);</span><br><span class="line">        _now_assem_byteix += size; <span class="comment">// ever there have bug</span></span><br><span class="line">      <span class="comment">//  _now_index = _now_assem_byteix;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(_end_index  == _now_assem_byteix + offset)<span class="comment">//have possible bug</span></span><br><span class="line">    &#123;</span><br><span class="line">        _output.<span class="built_in">end_input</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(_now_assem_byteix == _capacity )</span><br><span class="line">    &#123;</span><br><span class="line">        _full_flag++;</span><br><span class="line">        _now_index = <span class="number">0</span>;</span><br><span class="line">        _sum_bytes = <span class="number">0</span>;</span><br><span class="line">        _now_assem_byteix = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">StreamReassembler::unassembled_bytes</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> _sum_bytes - _now_assem_byteix;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">StreamReassembler::empty</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">unassembled_bytes</span>() == <span class="number">0</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">StreamReassembler::residue</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _capacity - _now_assem_byteix;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">uint64_t</span>  <span class="title">StreamReassembler::headno</span><span class="params">()</span> <span class="type">const</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _full_flag * _capacity + _now_assem_byteix;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="LAB2"><a href="#LAB2" class="headerlink" title="LAB2"></a>LAB2</h2><p>  本文要求实现一个处理Tcp连接请求接收消息的 TCP Receiver（ps） 由于我上面的写法是只管理了一个窗口于是在这节疯狂打补丁形成滑动窗口 （就是一个窗口装不下的时候，先缓存一下，然后在装）</p>
<h6 id="stream-reassembler-cc-打补丁"><a href="#stream-reassembler-cc-打补丁" class="headerlink" title="stream_reassembler.cc 打补丁"></a>stream_reassembler.cc 打补丁</h6><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//增加了俩个函数</span></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">StreamReassembler::residue</span><span class="params">()</span> <span class="type">const</span> <span class="comment">//该窗口剩余容量</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _capacity - _now_assem_byteix;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">uint64_t</span>  <span class="title">StreamReassembler::headno</span><span class="params">()</span> <span class="type">const</span> <span class="comment">//int64真实头长度</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _full_flag * _capacity + _now_assem_byteix;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="tcp-receiver-hh"><a href="#tcp-receiver-hh" class="headerlink" title="tcp_receiver.hh"></a>tcp_receiver.hh</h6><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">StreamReassembler _reassembler;</span><br><span class="line"></span><br><span class="line"><span class="comment">//! The maximum number of bytes we&#x27;ll store.</span></span><br><span class="line"><span class="type">size_t</span> _capacity;</span><br><span class="line"><span class="type">uint64_t</span> _isn&#123;<span class="number">0</span>&#125;;<span class="comment">// 记录一下isn </span></span><br><span class="line"><span class="type">int32_t</span> _start_flag &#123;&#125;;</span><br><span class="line"><span class="type">bool</span> _eof&#123;&#125;;</span><br><span class="line"><span class="type">int</span> _null_offset &#123;&#125;;</span><br></pre></td></tr></table></figure>

<h6 id="tcp-receiver-cc"><a href="#tcp-receiver-cc" class="headerlink" title="tcp_receiver.cc"></a>tcp_receiver.cc</h6><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">TCPReceiver::segment_received</span><span class="params">(<span class="type">const</span> TCPSegment &amp;seg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// syn and fin can possible  come here thar at the same time</span></span><br><span class="line">    <span class="type">uint64_t</span> index&#123;&#125;;           <span class="comment">// push_string index</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">1</span> == seg.<span class="built_in">header</span>().syn)  <span class="comment">// deal syn</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span> == _start_flag)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        _start_flag = <span class="number">1</span>;</span><br><span class="line">        _isn = seg.<span class="built_in">header</span>().seqno.<span class="built_in">raw_value</span>();</span><br><span class="line">        _null_offset++;</span><br><span class="line">        <span class="keyword">if</span> (seg.<span class="built_in">length_in_sequence_space</span>() == <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;  <span class="comment">// only syn</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> == _start_flag)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// @don`t have syn   then  deal flow push_string index</span></span><br><span class="line">  index = <span class="built_in">unwrap</span>(seg.<span class="built_in">header</span>().seqno, <span class="built_in">WrappingInt32</span>(_isn), _reassembler.<span class="built_in">headno</span>()) - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">1</span> == seg.<span class="built_in">header</span>().fin)  <span class="comment">// deal fin</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">1</span> == _eof)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        _eof = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">uint64_t</span> top = _reassembler.<span class="built_in">headno</span>() + _capacity;</span><br><span class="line">        <span class="type">uint64_t</span> low = _reassembler.<span class="built_in">headno</span>();</span><br><span class="line">        <span class="type">uint64_t</span> endindex = index + seg.<span class="built_in">payload</span>().<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">if</span> (seg.<span class="built_in">payload</span>().<span class="built_in">size</span>())</span><br><span class="line">            endindex--;</span><br><span class="line">        <span class="keyword">if</span> (index &gt;= top || endindex &lt; low )</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;  <span class="comment">// not in window</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//@ imitate sliding window at twice puhs_string</span></span><br><span class="line">    <span class="type">size_t</span> redata_size = seg.<span class="built_in">payload</span>().<span class="built_in">size</span>();            <span class="comment">// virtual size</span></span><br><span class="line">    <span class="type">size_t</span> now_remasmbler_size = _reassembler.<span class="built_in">residue</span>();  <span class="comment">// reality size</span></span><br><span class="line">    <span class="keyword">if</span> (now_remasmbler_size &lt; redata_size) &#123;</span><br><span class="line">        string data_tmp = seg.<span class="built_in">payload</span>().<span class="built_in">copy</span>();</span><br><span class="line">        _reassembler.<span class="built_in">push_substring</span>(data_tmp.<span class="built_in">substr</span>(<span class="number">0</span>, now_remasmbler_size), index , <span class="number">0</span>);</span><br><span class="line">        _reassembler.<span class="built_in">push_substring</span>(data_tmp.<span class="built_in">substr</span>(now_remasmbler_size , redata_size), index + now_remasmbler_size , seg.<span class="built_in">header</span>().fin);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        _reassembler.<span class="built_in">push_substring</span>(seg.<span class="built_in">payload</span>().<span class="built_in">copy</span>(), index, seg.<span class="built_in">header</span>().fin);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(_reassembler.<span class="built_in">stream_out</span>().<span class="built_in">input_ended</span>())</span><br><span class="line">        _null_offset++;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">optional&lt;WrappingInt32&gt; <span class="title">TCPReceiver::ackno</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (_start_flag)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="built_in">wrap</span>(_reassembler.<span class="built_in">headno</span>() + _null_offset, <span class="built_in">WrappingInt32</span>(_isn))&#125;;</span><br><span class="line">    <span class="keyword">return</span> std::<span class="literal">nullopt</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">TCPReceiver::window_size</span><span class="params">()</span> <span class="type">const</span>  <span class="comment">// virtual size</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _capacity - _reassembler.<span class="built_in">stream_out</span>().<span class="built_in">buffer_size</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="lab3"><a href="#lab3" class="headerlink" title="lab3"></a>lab3</h2><p>这节调试了好久，被迫学会vscode gdb 调试代码 由于英文水平问题理解了半天才知道他给的接口的调用方式</p>
<p>本实验要求实现一个TCPSender </p>
<p>1 开始系统调用构造函数并调用fill_window（） syn不能携带数据</p>
<p>2 当接收ACK超过_next_seqno 丢弃并返回false 或者小于已确认seq返回true 其他自行处理</p>
<p>3 超时一次 超时时长会乘2 （实行网络拥塞控制）</p>
<p>4 定时器启动时机（参考 自顶向下 的图3-33）</p>
<p>5 采取累计确认方式通过维护缓存队列重传</p>
<h6 id="tcp-sender-hh"><a href="#tcp-sender-hh" class="headerlink" title="tcp_sender.hh"></a>tcp_sender.hh</h6><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>:</span><br><span class="line">   <span class="comment">//! our initial sequence number, the number for our SYN.</span></span><br><span class="line">   WrappingInt32 _isn;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">//! outbound queue of segments that the TCPSender wants sent</span></span><br><span class="line">   std::queue&lt;TCPSegment&gt; _segments_out&#123;&#125;;</span><br><span class="line">   std::queue&lt;TCPSegment&gt; _now_tmp_data&#123;&#125;; <span class="comment">// unconfirmed</span></span><br><span class="line">   <span class="type">size_t</span> _bytes_in_flight&#123;&#125;;</span><br><span class="line">   <span class="comment">//! retransmission timer for the connection</span></span><br><span class="line">   <span class="type">unsigned</span> <span class="type">int</span> _initial_retransmission_timeout;</span><br><span class="line">   <span class="type">bool</span> _tick_flag &#123;&#125;;</span><br><span class="line">   <span class="type">uint64_t</span> _now_timer &#123;&#125;;</span><br><span class="line">   <span class="type">unsigned</span> <span class="type">int</span> _retransmission_count&#123;&#125;;</span><br><span class="line">   <span class="type">unsigned</span> <span class="type">int</span> _retransmission_timeout&#123;&#125;;</span><br><span class="line">   <span class="comment">//! outgoing stream of bytes that have not yet been sent</span></span><br><span class="line">   ByteStream _stream;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//! the (absolute) sequence number for the next byte to be sent</span></span><br><span class="line">   <span class="type">uint64_t</span> _next_seqno&#123;<span class="number">0</span>&#125;;</span><br><span class="line">   <span class="type">uint64_t</span> _recv_seq &#123;<span class="number">0</span>&#125;;</span><br><span class="line">   <span class="type">uint16_t</span> _receiver_window_size &#123;<span class="number">0</span>&#125;;</span><br><span class="line">   <span class="type">bool</span> _syn_flag &#123;&#125;;</span><br><span class="line">   <span class="type">bool</span> _fin_flag &#123;&#125;;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">....</span><br><span class="line">   <span class="function"><span class="type">void</span> <span class="title">loading_data</span><span class="params">( TCPSegment &amp; t)</span></span>;</span><br></pre></td></tr></table></figure>

<h6 id="tcp-sender"><a href="#tcp-sender" class="headerlink" title="tcp_sender"></a>tcp_sender</h6><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//! \param[in] capacity the capacity of the outgoing byte stream</span></span><br><span class="line"><span class="comment">//! \param[in] retx_timeout the initial amount of time to wait before retransmitting the oldest outstanding segment</span></span><br><span class="line"><span class="comment">//! \param[in] fixed_isn the Initial Sequence Number to use, if set (otherwise uses a random ISN)</span></span><br><span class="line">TCPSender::<span class="built_in">TCPSender</span>(<span class="type">const</span> <span class="type">size_t</span> capacity, <span class="type">const</span> <span class="type">uint16_t</span> retx_timeout, <span class="type">const</span> std::optional&lt;WrappingInt32&gt; fixed_isn)</span><br><span class="line">    : _isn(fixed_isn.<span class="built_in">value_or</span>(WrappingInt32&#123;<span class="built_in">random_device</span>()()&#125;))</span><br><span class="line">    , _initial_retransmission_timeout&#123;retx_timeout&#125;</span><br><span class="line">    , _stream(capacity) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">uint64_t</span> <span class="title">TCPSender::bytes_in_flight</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> _bytes_in_flight; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TCPSender::fill_window</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    TCPSegment t;</span><br><span class="line">    <span class="keyword">if</span> (!_syn_flag) &#123;</span><br><span class="line">        t.<span class="built_in">header</span>().syn = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in">loading_data</span>(t);</span><br><span class="line">        _syn_flag = <span class="literal">true</span>; </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">loading_data</span>(t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//! \param ackno The remote receiver&#x27;s ackno (acknowledgment number)</span></span><br><span class="line"><span class="comment">//! \param window_size The remote receiver&#x27;s advertised window size</span></span><br><span class="line"><span class="comment">//! \returns `false` if the ackno appears invalid (acknowledges something the TCPSender hasn&#x27;t sent yet)</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">TCPSender::ack_received</span><span class="params">(<span class="type">const</span> WrappingInt32 ackno, <span class="type">const</span> <span class="type">uint16_t</span> window_size)</span> </span>&#123;</span><br><span class="line">    <span class="type">uint64_t</span> dackno = <span class="built_in">unwrap</span>(ackno, _isn, _recv_seq);</span><br><span class="line">    <span class="comment">//cerr&lt;&lt;&quot;send_received &quot; &lt;&lt;dackno&lt;&lt; &quot; _next_sqeno&quot; &lt;&lt; _next_seqno&lt;&lt;&quot; _recv_sqe&quot; &lt;&lt; _recv_seq&lt;&lt;endl;</span></span><br><span class="line">    <span class="keyword">if</span> (dackno &gt; _next_seqno) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    _receiver_window_size = window_size;</span><br><span class="line">    <span class="keyword">if</span> (dackno &lt;=_recv_seq) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    _recv_seq = dackno;</span><br><span class="line">    <span class="keyword">while</span>(_now_tmp_data.<span class="built_in">size</span>())&#123;</span><br><span class="line">	    TCPSegment seg = _now_tmp_data.<span class="built_in">front</span>();</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">unwrap</span>(seg.<span class="built_in">header</span>().seqno, _isn, _next_seqno) + seg.<span class="built_in">length_in_sequence_space</span>() &lt;= dackno) &#123;</span><br><span class="line">            _bytes_in_flight -= seg.<span class="built_in">length_in_sequence_space</span>();</span><br><span class="line">            _now_tmp_data.<span class="built_in">pop</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">	    &#125; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fill_window</span>();</span><br><span class="line">    _retransmission_timeout = _initial_retransmission_timeout;</span><br><span class="line">    _retransmission_count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (_bytes_in_flight) &#123;</span><br><span class="line">        _now_timer = <span class="number">0</span>;</span><br><span class="line">        _tick_flag = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//! \param[in] ms_since_last_tick the number of milliseconds since the last call to this method</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TCPSender::tick</span><span class="params">(<span class="type">const</span> <span class="type">size_t</span> ms_since_last_tick)</span> </span>&#123;</span><br><span class="line">    _now_timer += ms_since_last_tick;</span><br><span class="line">    <span class="keyword">if</span> (_now_timer &gt;= _retransmission_timeout &amp;&amp; _now_tmp_data.<span class="built_in">size</span>()) &#123;</span><br><span class="line">        _segments_out.<span class="built_in">push</span>(_now_tmp_data.<span class="built_in">front</span>());</span><br><span class="line">        _retransmission_count++;</span><br><span class="line">        _retransmission_timeout *= <span class="number">2</span>;</span><br><span class="line">        _now_timer = <span class="number">0</span>;</span><br><span class="line">        _tick_flag = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(_now_tmp_data.<span class="built_in">size</span>() == <span class="number">0</span>) _tick_flag = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">int</span> <span class="title">TCPSender::consecutive_retransmissions</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> _retransmission_count; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TCPSender::send_empty_segment</span><span class="params">()</span>  <span class="comment">// only emtpy seqno</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TCPSegment t;</span><br><span class="line">    t.<span class="built_in">header</span>().seqno = <span class="built_in">wrap</span>(_next_seqno, _isn);</span><br><span class="line">    _segments_out.<span class="built_in">push</span>(t);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TCPSender::send_empty_segment</span><span class="params">(WrappingInt32 seq)</span>  <span class="comment">// only emtpy seqno</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TCPSegment t;</span><br><span class="line">    t.<span class="built_in">header</span>().seqno = seq;</span><br><span class="line">    _segments_out.<span class="built_in">push</span>(t);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TCPSender::loading_data</span><span class="params">(TCPSegment &amp;tmp)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (_fin_flag)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="type">int</span> b_flag = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> win = _receiver_window_size == <span class="number">0</span> ? <span class="number">1</span> : _receiver_window_size;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        TCPSegment t = tmp;</span><br><span class="line">        t.<span class="built_in">header</span>().seqno = <span class="built_in">wrap</span>(_next_seqno, _isn);</span><br><span class="line">        string data = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (_syn_flag) &#123;</span><br><span class="line">            <span class="keyword">if</span> (_stream.<span class="built_in">buffer_empty</span>() &amp;&amp; !_stream.<span class="built_in">eof</span>())</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="type">size_t</span> size = win - (_next_seqno - _recv_seq);</span><br><span class="line">            size = <span class="built_in">min</span>(TCPConfig::MAX_PAYLOAD_SIZE, size);</span><br><span class="line">            data = _stream.<span class="built_in">read</span>(size);</span><br><span class="line">            t.<span class="built_in">payload</span>() = <span class="built_in">Buffer</span>(std::<span class="built_in">move</span>(data));</span><br><span class="line">            <span class="keyword">if</span> (_stream.<span class="built_in">eof</span>() &amp;&amp; size &gt; data.<span class="built_in">size</span>()) &#123;</span><br><span class="line">                t.<span class="built_in">header</span>().fin = <span class="literal">true</span>;</span><br><span class="line">                _fin_flag = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">	    <span class="keyword">if</span>(t.<span class="built_in">length_in_sequence_space</span>() == <span class="number">0</span>) <span class="keyword">return</span> ;</span><br><span class="line">        _bytes_in_flight += t.<span class="built_in">length_in_sequence_space</span>();</span><br><span class="line">        _next_seqno += t.<span class="built_in">length_in_sequence_space</span>();</span><br><span class="line">        _now_tmp_data.<span class="built_in">push</span>(t);</span><br><span class="line">        _segments_out.<span class="built_in">push</span>(t);</span><br><span class="line">        b_flag++;</span><br><span class="line">    &#125; <span class="keyword">while</span> (_syn_flag &amp;&amp; _stream.<span class="built_in">buffer_size</span>());</span><br><span class="line">    <span class="keyword">if</span> (b_flag == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (!_tick_flag) &#123;</span><br><span class="line">        _retransmission_timeout = _initial_retransmission_timeout;</span><br><span class="line">        _retransmission_count = <span class="number">0</span>;</span><br><span class="line">        _tick_flag = <span class="number">1</span>;</span><br><span class="line">        _now_timer = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="lab4"><a href="#lab4" class="headerlink" title="lab4"></a>lab4</h2><p>lab4也是我做了一个时间挺长的了将近有10多天，其中学了shell编程，看了懂一点shell脚本，为了调试用脚本写的案例，思路感觉就是tcp状态机疯狂接触边界情况（测试用例挺全的）由于我太菜只能按着状态写了定义了一个_state用来表示LISTEN CLOSED等状态，代码简直不可阅读，太丑了，基本上代码思路就是下面的图了，顺便说一句，其实要是之前实现的lab够健壮，lab4也就没那么难了</p>
<p><img src="/images/assets/1683900423271.png" alt="1683900423271"></p>
<p><img src="/images/assets/1683900625517.png" alt="1683900625517"></p>
<p>把上面的图理解明白，我觉得基本上可以写出大概疯狂调试了</p>
<p>思路也不想记录了，实在边边角角有点多不过（2019的lab其实有个测试点是不太对的，和直接用ctest的测试点结果是正好相反的，不过既然lab就这样写了那就这样吧）</p>
<h5 id="调试方法与bug"><a href="#调试方法与bug" class="headerlink" title="调试方法与bug"></a>调试方法与bug</h5><p>好多人都说测试点实在国外，169哪个是在本机模拟的，如果shell脚本以后测试点timeout或者failure</p>
<p>多半是因为代码问题，可能就是边边角角问题，如无法正确关闭，一方关闭一方还在发消息等等，剩下hash码不对的话，要么之前的lab有问题，要么就是用了cout ，或者有可能是防火墙的问题</p>
<p>虽然思路没有，但是调式总是值得记录的（因为每天都在调试）</p>
<h6 id="方法一：gdb"><a href="#方法一：gdb" class="headerlink" title="方法一：gdb"></a>方法一：gdb</h6><p>可以用vscode里的，也可以直接用命令行的，不过我喜欢用vscode的，简单配置一下就行，然后就是去按照test的文件名在tests打断点，可以搭配#ifdef #endif把部分代码块过滤掉，如果需要输出信息的话</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">	<span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">		<span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sponge debug&quot;</span><span class="punctuation">,</span><span class="comment">//!挑个容易识别的名字</span></span><br><span class="line">			<span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cppdbg&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;/build/tests/$&#123;fileBasenameNoExtension&#125;&quot;</span><span class="punctuation">,</span> <span class="comment">//!设置为测试程序源码相对应的目标程序路径</span></span><br><span class="line">			<span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;stopAtEntry&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;environment&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;externalConsole&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;MIMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gdb&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;setupCommands&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">				<span class="punctuation">&#123;</span></span><br><span class="line">					<span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;为 gdb 启用整齐打印&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;-enable-pretty-printing&quot;</span><span class="punctuation">,</span></span><br><span class="line">					<span class="attr">&quot;ignoreFailures&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">				<span class="punctuation">&#125;</span></span><br><span class="line">			<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">			<span class="comment">//&quot;preLaunchTask&quot;: &quot;C/C++: g++-8 build active file&quot;,  //!不需要前置任务</span></span><br><span class="line">			<span class="attr">&quot;miDebuggerPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/usr/bin/gdb&quot;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h6 id="方法二：cout-日志"><a href="#方法二：cout-日志" class="headerlink" title="方法二：cout|日志"></a>方法二：cout|日志</h6><p>简单暴力使用#define FF  (FF cout&lt;&lt;….)  一键开关使用，不过需要输出多就不推荐了，可以使用输出到日志里</p>
<h6 id="方法三：抓包"><a href="#方法三：抓包" class="headerlink" title="方法三：抓包"></a>方法三：抓包</h6><p>由于上述只适用于lab4的非shell写的调试真正调试还得抓包用ctest跑一个测试用例然后用tshark在另一个终端抓包，有的基于udp可能会抓不到包，不过就在tun144 tun145这俩个网卡切换着抓看看吧</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tshark -i tun144 后面有选项可以输出到文件什么的看--help就行</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctest --ouput-on-faliure -V -R t_icD_128K_8K_lL //测试用例</span><br></pre></td></tr></table></figure>

<p>方法四：控制变量想知道自己的lab前几个有没有问题，去网上找个lab4没问题的clone下来，接口反正一样，测试一下看看自己的有问题没。（虽说是歪门邪道）</p>
<p>在坚持不懈的努力下终于看到了100% passed，真不容易，虽然代码有问题（只要经过多次测试，出现timeout或者failure就是有问题的）但是感觉自己还是学到了很多东西，剩下的bug我就不找了，很难找了（不是因为我懒）放一下截图吧，好歹还是通过了，代码就不放了太丑了</p>
<p>、<img src="/images/assets/1683896785929.png" alt="1683896785929"></p>
<p><img src="/images/assets/1683896910636.png" alt="1683896910636"></p>
<h2 id="lab5"><a href="#lab5" class="headerlink" title="lab5"></a>lab5</h2><p>本lab还是比较简单的，花费了一会改改bug就写完了，主要是明白各个接口的定义，实现一个arp，根据ip查看mac地址，并且缓存下缓存也有时效30秒讲义上，而且如果arp广播发送5秒没响应下次还得发</p>
<h6 id="network-interface-hh"><a href="#network-interface-hh" class="headerlink" title="network_interface.hh"></a>network_interface.hh</h6><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>: </span><br><span class="line">   <span class="comment">//! Ethernet (known as hardware, network-access-layer, or link-layer) address of the interface</span></span><br><span class="line">   <span class="keyword">struct</span> <span class="title class_">MemoryEthAddr</span> &#123;</span><br><span class="line">       EthernetAddress _mac;</span><br><span class="line">       std::<span class="type">size_t</span> _ttl;</span><br><span class="line">   &#125;;</span><br><span class="line">   std::unordered_map&lt;<span class="type">uint32_t</span>, MemoryEthAddr&gt; _ip_mac &#123;&#125;;</span><br><span class="line">   <span class="type">size_t</span> _now_time &#123;&#125;;</span><br><span class="line">   std::unordered_map&lt;<span class="type">uint32_t</span> , <span class="type">size_t</span>&gt; _last_time &#123;&#125;; </span><br><span class="line">   std::unordered_map&lt;<span class="type">uint32_t</span>,std::vector&lt;EthernetFrame&gt;&gt; _frame_wait&#123;&#125;;</span><br><span class="line"></span><br><span class="line">   EthernetAddress _ethernet_address &#123;&#125;;</span><br><span class="line">   <span class="comment">//! IP (known as internet-layer or network-layer) address of the interface</span></span><br><span class="line">   Address _ip_address;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//! outbound queue of Ethernet frames that the NetworkInterface wants sent</span></span><br><span class="line">   std::queue&lt;EthernetFrame&gt; _frames_out&#123;&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="network-interface-cc"><a href="#network-interface-cc" class="headerlink" title="network_interface.cc"></a>network_interface.cc</h6><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">NetworkInterface::<span class="built_in">NetworkInterface</span>(<span class="type">const</span> EthernetAddress &amp;ethernet_address, <span class="type">const</span> Address &amp;ip_address)</span><br><span class="line">    : _ethernet_address(ethernet_address), _ip_address(ip_address) &#123;</span><br><span class="line">    cerr &lt;&lt; <span class="string">&quot;DEBUG: Network interface has Ethernet address &quot;</span> &lt;&lt; <span class="built_in">to_string</span>(_ethernet_address) &lt;&lt; <span class="string">&quot; and IP address &quot;</span></span><br><span class="line">         &lt;&lt; ip_address.<span class="built_in">ip</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//! \param[in] dgram the IPv4 datagram to be sent</span></span><br><span class="line"><span class="comment">//! \param[in] next_hop the IP address of the interface to send it to (typically a router or default gateway, but may also be another host if directly connected to the same network as the destination)</span></span><br><span class="line"><span class="comment">//! (Note: the Address type can be converted to a uint32_t (raw 32-bit IP address) with the Address::ipv4_numeric() method.)</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">NetworkInterface::send_datagram</span><span class="params">(<span class="type">const</span> InternetDatagram &amp;dgram, <span class="type">const</span> Address &amp;next_hop)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// convert IP address of next hop to raw 32-bit representation (used in ARP header)</span></span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> next_hop_ip = next_hop.<span class="built_in">ipv4_numeric</span>();</span><br><span class="line">    EthernetFrame frame;</span><br><span class="line">    frame.<span class="built_in">payload</span>().<span class="built_in">append</span>(dgram.<span class="built_in">serialize</span>());</span><br><span class="line">    frame.<span class="built_in">header</span>().src = _ethernet_address;</span><br><span class="line">    frame.<span class="built_in">header</span>().type = EthernetHeader::TYPE_IPv4;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(_ip_mac.<span class="built_in">count</span>(next_hop_ip) == <span class="number">0</span> || _ip_mac[next_hop_ip]._ttl  +  <span class="number">30000</span> &lt;= _now_time)&#123;</span><br><span class="line">        _frame_wait[next_hop_ip].<span class="built_in">push_back</span>(frame);</span><br><span class="line">        <span class="keyword">if</span>(_frame_wait[next_hop_ip].<span class="built_in">size</span>() &gt; <span class="number">1</span> &amp;&amp; _last_time[next_hop_ip] + <span class="number">5000</span> &gt;= _now_time) <span class="keyword">return</span> ;</span><br><span class="line">        EthernetFrame _look_for;</span><br><span class="line">        _look_for.<span class="built_in">header</span>().src = _ethernet_address;</span><br><span class="line">        _look_for.<span class="built_in">header</span>().type = EthernetHeader::TYPE_ARP;</span><br><span class="line">        _look_for.<span class="built_in">header</span>().dst = ETHERNET_BROADCAST;</span><br><span class="line">        ARPMessage mes;</span><br><span class="line">        mes.opcode = ARPMessage::OPCODE_REQUEST;</span><br><span class="line">        mes.sender_ethernet_address = _ethernet_address;</span><br><span class="line">        mes.sender_ip_address = _ip_address.<span class="built_in">ipv4_numeric</span>();</span><br><span class="line">        mes.target_ip_address =  next_hop_ip ;</span><br><span class="line"></span><br><span class="line">        _look_for.<span class="built_in">payload</span>().<span class="built_in">append</span>(mes.<span class="built_in">serialize</span>());</span><br><span class="line">        _last_time[next_hop_ip] = _now_time;</span><br><span class="line">        _frames_out.<span class="built_in">push</span>(<span class="built_in">move</span>(_look_for));</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        frame.<span class="built_in">header</span>().dst = _ip_mac[next_hop_ip]._mac;</span><br><span class="line">        _frames_out.<span class="built_in">push</span>(<span class="built_in">move</span>(frame));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//! \param[in] frame the incoming Ethernet frame</span></span><br><span class="line"><span class="function">optional&lt;InternetDatagram&gt; <span class="title">NetworkInterface::recv_frame</span><span class="params">(<span class="type">const</span> EthernetFrame &amp;frame)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(frame.<span class="built_in">header</span>().dst != _ethernet_address &amp;&amp; frame.<span class="built_in">header</span>().dst != ETHERNET_BROADCAST )</span><br><span class="line">        <span class="keyword">return</span> std::<span class="literal">nullopt</span>;</span><br><span class="line">    <span class="keyword">if</span>(frame.<span class="built_in">header</span>().type == EthernetHeader::TYPE_IPv4)</span><br><span class="line">    &#123;</span><br><span class="line">        InternetDatagram data;</span><br><span class="line">        data.<span class="built_in">parse</span>(frame.<span class="built_in">payload</span>());</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(frame.<span class="built_in">header</span>().type == EthernetHeader::TYPE_ARP )</span><br><span class="line">    &#123;</span><br><span class="line">        ARPMessage mes;</span><br><span class="line">        mes.<span class="built_in">parse</span>(frame.<span class="built_in">payload</span>());</span><br><span class="line">        <span class="keyword">if</span>(mes.target_ip_address != _ip_address.<span class="built_in">ipv4_numeric</span>()) <span class="keyword">return</span> std::<span class="literal">nullopt</span>;</span><br><span class="line">        MemoryEthAddr m_eth;</span><br><span class="line">        m_eth._mac = mes.sender_ethernet_address;</span><br><span class="line">        m_eth._ttl = _now_time;</span><br><span class="line">        _ip_mac[mes.sender_ip_address] = m_eth;</span><br><span class="line">        <span class="keyword">if</span>(frame.<span class="built_in">header</span>().dst == ETHERNET_BROADCAST  )</span><br><span class="line">        &#123;</span><br><span class="line">            ARPMessage send_mes;</span><br><span class="line">            send_mes.opcode = ARPMessage::OPCODE_REPLY;</span><br><span class="line">            send_mes.sender_ethernet_address = _ethernet_address;</span><br><span class="line">            send_mes.sender_ip_address = _ip_address.<span class="built_in">ipv4_numeric</span>();</span><br><span class="line">            send_mes.target_ip_address =  mes.sender_ip_address; </span><br><span class="line">            send_mes.target_ethernet_address = mes.sender_ethernet_address;</span><br><span class="line">            EthernetFrame frm;</span><br><span class="line">            frm.<span class="built_in">payload</span>().<span class="built_in">append</span>(send_mes.<span class="built_in">serialize</span>());</span><br><span class="line">            frm.<span class="built_in">header</span>().src = _ethernet_address;</span><br><span class="line">            frm.<span class="built_in">header</span>().dst = mes.sender_ethernet_address;</span><br><span class="line">            frm.<span class="built_in">header</span>().type = EthernetHeader::TYPE_ARP;</span><br><span class="line">            _frames_out.<span class="built_in">push</span>(<span class="built_in">move</span>(frm));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(_frame_wait.<span class="built_in">count</span>(mes.sender_ip_address) != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(EthernetFrame &amp;frm : _frame_wait[mes.sender_ip_address] )</span><br><span class="line">            &#123;</span><br><span class="line">                frm.<span class="built_in">header</span>().dst = frame.<span class="built_in">header</span>().src;</span><br><span class="line">                _frames_out.<span class="built_in">push</span>(frm);</span><br><span class="line">            &#125;</span><br><span class="line">            _frame_wait[mes.sender_ip_address].<span class="built_in">clear</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//! \param[in] ms_since_last_tick the number of milliseconds since the last call to this method</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">NetworkInterface::tick</span><span class="params">(<span class="type">const</span> <span class="type">size_t</span> ms_since_last_tick)</span> </span>&#123; </span><br><span class="line">    _now_time += ms_since_last_tick;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="lab6"><a href="#lab6" class="headerlink" title="lab6"></a>lab6</h2><p>这个lab也挺简单，lab5和lab6一共没花几个小时就搞定了，就是根据包的目标ip转发到指定网卡接口上</p>
<h6 id="router-hh"><a href="#router-hh" class="headerlink" title="router.hh"></a>router.hh</h6><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;AsyncNetworkInterface&gt; _interfaces&#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//! Send a single datagram from the appropriate outbound interface to the next hop,</span></span><br><span class="line">  <span class="comment">//! as specified by the route with the longest prefix_length that matches the</span></span><br><span class="line">  <span class="comment">//! datagram&#x27;s destination address.</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">route_one_datagram</span><span class="params">(InternetDatagram &amp;dgram)</span></span>;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">RouteMessage</span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="type">uint32_t</span> route_prefix;</span><br><span class="line">      <span class="type">uint8_t</span> prefix_length;</span><br><span class="line">      std::optional&lt;Address&gt; next_hop;</span><br><span class="line">      <span class="type">size_t</span> interface_num;</span><br><span class="line">  &#125;;</span><br><span class="line">  std::vector&lt;RouteMessage&gt; _rt_mes &#123;&#125;;</span><br></pre></td></tr></table></figure>

<h6 id="router-cc"><a href="#router-cc" class="headerlink" title="router.cc"></a>router.cc</h6><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;router.hh&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bitset&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Dummy implementation of an IP router</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Given an incoming Internet datagram, the router decides</span></span><br><span class="line"><span class="comment">// (1) which interface to send it out on, and</span></span><br><span class="line"><span class="comment">// (2) what next hop address to send it to.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// For Lab 6, please replace with a real implementation that passes the</span></span><br><span class="line"><span class="comment">// automated checks run by `make check_lab6`.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// You will need to add private members to the class declaration in `router.hh`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span>... Targs&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DUMMY_CODE</span><span class="params">(Targs &amp;&amp;... <span class="comment">/* unused */</span>)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//! \param[in] route_prefix The &quot;up-to-32-bit&quot; IPv4 address prefix to match the datagram&#x27;s destination address against</span></span><br><span class="line"><span class="comment">//! \param[in] prefix_length For this route to be applicable, how many high-order (most-significant) bits of the route_prefix will need to match the corresponding bits of the datagram&#x27;s destination address?</span></span><br><span class="line"><span class="comment">//! \param[in] next_hop The IP address of the next hop. Will be empty if the network is directly attached to the router (in which case, the next hop address should be the datagram&#x27;s final destination).</span></span><br><span class="line"><span class="comment">//! \param[in] interface_num The index of the interface to send the datagram out on.</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Router::add_route</span><span class="params">(<span class="type">const</span> <span class="type">uint32_t</span> route_prefix,</span></span></span><br><span class="line"><span class="params"><span class="function">                       <span class="type">const</span> <span class="type">uint8_t</span> prefix_length,</span></span></span><br><span class="line"><span class="params"><span class="function">                       <span class="type">const</span> optional&lt;Address&gt; next_hop,</span></span></span><br><span class="line"><span class="params"><span class="function">                       <span class="type">const</span> <span class="type">size_t</span> interface_num)</span> </span>&#123;</span><br><span class="line">    cerr &lt;&lt; <span class="string">&quot;DEBUG: adding route &quot;</span> &lt;&lt; Address::<span class="built_in">from_ipv4_numeric</span>(route_prefix).<span class="built_in">ip</span>() &lt;&lt; <span class="string">&quot;/&quot;</span> &lt;&lt; <span class="built_in">int</span>(prefix_length)</span><br><span class="line">         &lt;&lt; <span class="string">&quot; =&gt; &quot;</span> &lt;&lt; (next_hop.<span class="built_in">has_value</span>() ? next_hop-&gt;<span class="built_in">ip</span>() : <span class="string">&quot;(direct)&quot;</span>) &lt;&lt; <span class="string">&quot; on interface &quot;</span> &lt;&lt; interface_num &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    _rt_mes.<span class="built_in">push_back</span>(&#123;route_prefix,prefix_length , next_hop ,interface_num &#125;);</span><br><span class="line">    <span class="comment">// Your code here.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//! \param[in] dgram The datagram to be routed</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Router::route_one_datagram</span><span class="params">(InternetDatagram &amp;dgram)</span> </span>&#123;</span><br><span class="line">    string ips = <span class="built_in">bitset</span>&lt;<span class="number">32</span>&gt;(dgram.<span class="built_in">header</span>().dst).<span class="built_in">to_string</span>();</span><br><span class="line">    <span class="type">uint8_t</span> max_length = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> flag = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">size_t</span> p =<span class="number">0</span> ;p &lt; _rt_mes.<span class="built_in">size</span>() ; p++)&#123;</span><br><span class="line">        <span class="keyword">auto</span> &amp; i = _rt_mes[p];</span><br><span class="line">        string t =<span class="built_in">bitset</span>&lt;<span class="number">32</span>&gt;(i.route_prefix).<span class="built_in">to_string</span>();</span><br><span class="line">        <span class="keyword">if</span>(t.<span class="built_in">substr</span>(<span class="number">0</span> , i.prefix_length) == ips.<span class="built_in">substr</span>(<span class="number">0</span> , i.prefix_length))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(i.prefix_length &gt; max_length || flag)</span><br><span class="line">            &#123;</span><br><span class="line">                max_length = i.prefix_length;</span><br><span class="line">                index = p;</span><br><span class="line">                flag = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(flag) <span class="keyword">return</span> ;</span><br><span class="line">    <span class="keyword">if</span>(dgram.<span class="built_in">header</span>().ttl &lt;= <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    dgram.<span class="built_in">header</span>().ttl--;</span><br><span class="line">    <span class="keyword">if</span>(_rt_mes[index].next_hop.<span class="built_in">has_value</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">interface</span>(_rt_mes[index].interface_num).<span class="built_in">send_datagram</span>(dgram , _rt_mes[index].next_hop.<span class="built_in">value</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">interface</span>(_rt_mes[index].interface_num).<span class="built_in">send_datagram</span>(dgram , Address::<span class="built_in">from_ipv4_numeric</span>(dgram.<span class="built_in">header</span>().dst));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Router::route</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Go through all the interfaces, and route every incoming datagram to its proper outgoing interface.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;interface : _interfaces) &#123;</span><br><span class="line">        <span class="keyword">auto</span> &amp;queue = interface.<span class="built_in">datagrams_out</span>();</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">not</span> queue.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            <span class="built_in">route_one_datagram</span>(queue.<span class="built_in">front</span>());</span><br><span class="line">            queue.<span class="built_in">pop</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完结截图</p>
<p><img src="/images/assets/1684159752455.png" alt="1684159752455"></p>
<h2 id="summary"><a href="#summary" class="headerlink" title="summary:"></a>summary:</h2><p>至此 cs144 lab就完结了，其他的lab每个几乎就是一天就完成了，只有lab4来来回回调试了10天左右，加起来完成这个lab一个花费了半个月，lab4找bug一百多个案例真是忘不了，各种goole，baidu，最后发现防火墙挡住了一大半，哭死。不过这个lab真的让我学会很多东西，也稍微学了一些 git shell 抓包的知识，还有就是英语，每次看英语文档看大半天然后再看别人给出的翻译，不过话说，英语阅读有点长进了，哈哈，下一个lab就是数据库了，有了这些完美的课程，总算我感觉我的大学cs生涯才是perfect</p>

    </div>

    
    
    

      
      <div>
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:24px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>
      </div>
      

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/cs144lab/" rel="tag"># cs144lab</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/05/13/MySQL/" rel="prev" title="MySQL">
      <i class="fa fa-chevron-left"></i> MySQL
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/06/07/LRU/" rel="next" title="LRU缓存 算法实现与分析">
      LRU缓存 算法实现与分析 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E3%80%90%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E3%80%91cs144-lab"><span class="nav-number">1.</span> <span class="nav-text">【计算机网络】cs144 lab</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#LAB0"><span class="nav-number">1.1.</span> <span class="nav-text">LAB0</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Writing-webget"><span class="nav-number">1.1.0.0.0.1.</span> <span class="nav-text">Writing webget</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#An-in-memory-reliable-byte-stream"><span class="nav-number">1.1.0.0.0.2.</span> <span class="nav-text">An in-memory reliable byte stream</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LAB1"><span class="nav-number">1.2.</span> <span class="nav-text">LAB1</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#stream-reassembler-hh"><span class="nav-number">1.2.0.0.0.1.</span> <span class="nav-text">stream_reassembler.hh</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#stream-reassembler-cc"><span class="nav-number">1.2.0.0.0.2.</span> <span class="nav-text">stream_reassembler.cc</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LAB2"><span class="nav-number">1.3.</span> <span class="nav-text">LAB2</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#stream-reassembler-cc-%E6%89%93%E8%A1%A5%E4%B8%81"><span class="nav-number">1.3.0.0.0.1.</span> <span class="nav-text">stream_reassembler.cc 打补丁</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#tcp-receiver-hh"><span class="nav-number">1.3.0.0.0.2.</span> <span class="nav-text">tcp_receiver.hh</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#tcp-receiver-cc"><span class="nav-number">1.3.0.0.0.3.</span> <span class="nav-text">tcp_receiver.cc</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lab3"><span class="nav-number">1.4.</span> <span class="nav-text">lab3</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#tcp-sender-hh"><span class="nav-number">1.4.0.0.0.1.</span> <span class="nav-text">tcp_sender.hh</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#tcp-sender"><span class="nav-number">1.4.0.0.0.2.</span> <span class="nav-text">tcp_sender</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lab4"><span class="nav-number">1.5.</span> <span class="nav-text">lab4</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95%E4%B8%8Ebug"><span class="nav-number">1.5.0.0.1.</span> <span class="nav-text">调试方法与bug</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80%EF%BC%9Agdb"><span class="nav-number">1.5.0.0.1.1.</span> <span class="nav-text">方法一：gdb</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C%EF%BC%9Acout-%E6%97%A5%E5%BF%97"><span class="nav-number">1.5.0.0.1.2.</span> <span class="nav-text">方法二：cout|日志</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%B8%89%EF%BC%9A%E6%8A%93%E5%8C%85"><span class="nav-number">1.5.0.0.1.3.</span> <span class="nav-text">方法三：抓包</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lab5"><span class="nav-number">1.6.</span> <span class="nav-text">lab5</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#network-interface-hh"><span class="nav-number">1.6.0.0.0.1.</span> <span class="nav-text">network_interface.hh</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#network-interface-cc"><span class="nav-number">1.6.0.0.0.2.</span> <span class="nav-text">network_interface.cc</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lab6"><span class="nav-number">1.7.</span> <span class="nav-text">lab6</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#router-hh"><span class="nav-number">1.7.0.0.0.1.</span> <span class="nav-text">router.hh</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#router-cc"><span class="nav-number">1.7.0.0.0.2.</span> <span class="nav-text">router.cc</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#summary"><span class="nav-number">1.8.</span> <span class="nav-text">summary:</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="dying"
      src="/images/head.jpg">
  <p class="site-author-name" itemprop="name">dying</p>
  <div class="site-description" itemprop="description">想都是问题，做才是答案</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">16</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/QYZing" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;QYZing" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:2062656460@qq.com" title="E-Mail → mailto:2062656460@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">蒙ICP备2023000237号-1 </a>
  </div>

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">dying</span>
</div>

    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <span id="busuanzi_container_site_pv">总访问量<span id="busuanzi_value_site_pv"></span>次</span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_uv">总访客数<span id="busuanzi_value_site_uv"></span>人</span>
    <span class="post-meta-divider">|</span>
<!-- 不蒜子计数初始值纠正 -->
<script>
$(document).ready(function() {

    var int = setInterval(fixCount, 50);  // 50ms周期检测函数
    var countOffset = 20000;  // 初始化首次数据

    function fixCount() {            
       if (document.getElementById("busuanzi_container_site_pv").style.display != "none")
        {
            $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + countOffset); 
            clearInterval(int);
        }                  
        if ($("#busuanzi_container_site_pv").css("display") != "none")
        {
            $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + countOffset); // 加上初始数据 
            clearInterval(int); // 停止检测
        }  
    }
       	
});
</script> 

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>
    <script defer src="/lib/three/canvas_sphere.min.js"></script>


  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'wFD2TJDXerlwQLJQOksbriCK-gzGzoHsz',
      appKey     : 'ErOISFE8uucXKBtDq5EVrhh4',
      placeholder: "输入你的评论",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '3' || 10,
      visitor    : true,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
